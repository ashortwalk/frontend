<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Map with Tmap API</title>
    <style>
      #map_div {
        width: 280px;
        height: 100%;
      }
      #result {
        margin-top: 20px;
      }
    </style>
    <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=REACT_APP_TMAP_API_KEY"></script>
  </head>
  <body>
    <div id="map_div"></div>
    <input id="address" />
    <button id="drawLineBtn">경로 그리기</button>
    <p id="result"></p>
    <div id="route"></div>

    <script>
      try {
        const { Tmapv2 } = window;
        const headers = { appKey: "REACT_APP_TMAP_API_KEY" };
        let map;
        let marker_s, marker_e;
        let drawInfoArr = [];
        let resultdrawArr = [];
        let intermediatePoints = [];
        let geocoder;
        let addresses = [];

        // GPT API 호출 및 주소 분석
        async function gpt(address) {
          initTmap();
          drawInfoArr = [];
          resultdrawArr = [];
          intermediatePoints = [];
          addresses = [];
          const keyRespnose = await fetch("http://127.0.0.1:8000/api/key/gpt");
          const keyResult = await keyRespnose.json();
          const key = keyResult.gptKey;
          const promptData = {
            messages: [
              {
                role: "system",
                content:
                  "너는 주어진 문장을 해석해서 도로명주소만을 배열에 담아 json으로 감싸 출력하는 AI야.",
              },
              {
                role: "user",
                content: `${address}에서 출발하고 끝나는 총 3km의 왕복 산책 코스의 출발지 1개의 도로명주소와 중간지점 5개 도로명주소를 배열에 담아서 data라는 key를 가진 json에 넣어 줘.`,
              },
            ],
          };
          const gptResponse = await fetch(
            "https://warme-m3p2wioi-francecentral.cognitiveservices.azure.com/openai/deployments/gpt-4o/chat/completions?api-version=2024-08-01-preview",
            {
              method: "POST",
              headers: { "api-key": key, "Content-Type": "application/json" },
              body: JSON.stringify(promptData),
            }
          );
          const gptResult = await gptResponse.json();
          const cleanedResult = gptResult.choices[0].message.content
            .replace(/^```json\n/, "")
            .replace(/\n```$/, "")
            .trim();
          const result = await JSON.parse(cleanedResult);

          // geocoding 처리 후 경로 그리기
          await Promise.all(
            result.data.map((addressStr) => {
              return new Promise((resolve) => {
                setTimeout(async () => {
                  await geocoding(addressStr);
                  resolve(); // geocoding 완료 후 resolve
                }, 300);
              });
            })
          ).finally(() => {
            // 모든 geocoding이 완료된 후 경로 요청
            fetchRouteData();
          });
        }

        // 주소를 좌표로 변환
        async function geocoding(address) {
          addresses.push(address);
          const response = await fetch(
            `https://apis.openapi.sk.com/tmap/geo/fullAddrGeo?addressFlag=F02&coordType=WGS84GEO&version=1&fullAddr=${address}&page=1&count=1`,
            {
              method: "GET",
              headers,
            }
          );
          const result = await response.json();
          const data = {
            x: result.coordinateInfo.coordinate[0].newLat,
            y: result.coordinateInfo.coordinate[0].newLon,
          };
          intermediatePoints.push(new Tmapv2.LatLng(data.x, data.y));
        }

        // Tmap 지도 초기화
        function initTmap() {
          const mapDiv = document.getElementById("map_div");

          if (!mapDiv.firstChild) {
            map = new Tmapv2.Map("map_div", {
              center: new Tmapv2.LatLng(37.566481622437934, 126.98502302169841),
              width: "280px",
              height: "280px",
              zoom: 15,
            });
          }
        }

        // 경로 요청 및 지도에 그리기
        async function fetchRouteData() {
          if (intermediatePoints.length < 2) {
            alert("경로를 그릴 수 있는 충분한 점이 없습니다.");
            return;
          }

          const startPoint = intermediatePoints[0]; // 출발지
          const endPoint = intermediatePoints[intermediatePoints.length - 1]; // 도착지

          const requestData = {
            startX: startPoint.lng(),
            startY: startPoint.lat(),
            endX: endPoint.lng(),
            endY: endPoint.lat(),
            reqCoordType: "WGS84GEO",
            resCoordType: "EPSG3857",
            startName: "출발지",
            endName: "도착지",
          };

          try {
            const response = await fetch(
              "https://apis.openapi.sk.com/tmap/routes/pedestrian?version=1&format=json&callback=result",
              {
                method: "POST",
                headers: headers,
                body: JSON.stringify(requestData),
              }
            );

            const data = await response.json();

            if (response.ok) {
              processRouteData(data);
            } else {
              throw new Error("Failed to fetch route data");
            }
          } catch (error) {}
        }

        // 경로 데이터 처리 및 지도에 경로 그리기
        function processRouteData(responseData) {
          const resultData = responseData.features;

          // 기존 마커 및 선 제거
          resultdrawArr.forEach((marker) => marker.setMap(null));
          resultdrawArr = [];
          drawInfoArr = [];

          resultData.forEach((feature) => {
            const { geometry, properties } = feature;
            if (geometry.type === "LineString") {
              geometry.coordinates.forEach((coordinate) => {
                const latlng = new Tmapv2.Point(coordinate[0], coordinate[1]);
                const convertPoint =
                  new Tmapv2.Projection.convertEPSG3857ToWGS84GEO(latlng);
                const convertChange = new Tmapv2.LatLng(
                  convertPoint._lat,
                  convertPoint._lng
                );
                drawInfoArr.push(convertChange);
              });
            }
          });

          drawLine(drawInfoArr); // 지도에 경로 선 그리기
          moveMapCenterToMiddle(drawInfoArr); // 경로 중심으로 지도 이동
          addIntermediateMarkers(intermediatePoints); // 중간 지점 마커 추가

          const tDistance = `총 거리 : ${(
            resultData[0].properties.totalDistance / 1000
          ).toFixed(1)}km,`;
          const tTime = ` 총 시간 : ${(
            resultData[0].properties.totalTime / 60
          ).toFixed(0)}분`;
          document.querySelector("#result").innerHTML = tDistance + tTime;
          addresses.push(addresses[0]);
          const tempHTML = addresses
            .map((addr) => {
              return `<div id = "addr">${addr}<div>`;
            })
            .join("");
          document.querySelector("#route").innerHTML = tempHTML;
        }

        // 지도에 경로 선 그리기
        function drawLine(arrPoint) {
          const polyline = new Tmapv2.Polyline({
            path: arrPoint,
            strokeColor: "#DD0000",
            strokeWeight: 6,
            map: map,
          });
          resultdrawArr.push(polyline);
        }

        // 경로 중간 지점 마커 추가
        function addIntermediateMarkers(points) {
          points.forEach((point) => {
            const marker = new Tmapv2.Marker({
              position: point,
              icon: "http://topopen.tmap.co.kr/imgs/point.png",
              iconSize: new Tmapv2.Size(8, 8),
              map: map,
            });
            resultdrawArr.push(marker);
          });
        }

        // 경로 중심으로 지도 이동
        function moveMapCenterToMiddle(arrPoint) {
          let lat = 0;
          let lng = 0;
          arrPoint.forEach((point) => {
            lat += point.lat();
            lng += point.lng();
          });
          lat /= arrPoint.length;
          lng /= arrPoint.length;
          map.setCenter(new Tmapv2.LatLng(lat, lng));
        }

        // "경로 그리기" 버튼 클릭 시 처리
        document.getElementById("drawLineBtn").addEventListener("click", () => {
          document.querySelector("#result").innerHTML =
            "추천 경로를 탐색하고 있습니다.";
          const address = document.getElementById("address").value;
          if (address) {
            gpt(address);
          } else {
            alert("주소를 입력하세요.");
          }
        });

        // 지도 초기화
        initTmap();
      } catch (err) {
        gpt(address);
      }
    </script>
  </body>
</html>
